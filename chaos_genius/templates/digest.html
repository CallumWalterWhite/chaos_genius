<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChaosGenius Alerts Digest</title>

    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://unpkg.com/simple-datatables@3.2.0/dist/style.css" rel="stylesheet" type="text/css">
</head>

<body class="bg-white">
    <div class="container mx-auto py-4">
        <h1 class="text-3xl">ChaosGenius Alerts Digest</h1>

        <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-4 sm:ml-3 sm:w-auto sm:text-sm" onclick="downloadCSV()">Download CSV</button>

        <select id="email-select" multiple>
        </select>

    <!-- Tabs -->
    <ul id="tabs" class="inline-flex pt-2 px-1 w-full border-b">
        <li class="bg-white px-4 text-gray-800 font-semibold py-2 rounded-t border-t border-r border-l -mb-px"><a id="default-tab" href="#anomaly-alerts">Anomaly Alerts</a></li>
        <li class="px-4 text-gray-800 font-semibold py-2 rounded-t"><a href="#event-alerts">Event Alerts</a></li>
    </ul>

    <div id="tab-contents">
        <div id="anomaly-alerts" class="p-4">

            <div class="m-4">
               <div class="toggle colour flex">
                   <span>Show subdimensions:&nbsp</span><input id="subdims-check" class="toggle-checkbox hidden" type="checkbox">
                  <label for="subdims-check" class="toggle-label inline-block w-12 h-6 rounded-full transition-color duration-150 ease-out"></label>
               </div>
            </div>

            <div class="flex flex-col py-4">
                <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                    <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
                        <div class="shadow overflow-hidden border-b border-gray-200 bg-gray-100 sm:rounded-2xl">
                            <table class="min-w-full divide-y divide-gray-200 table-fixed w-full" id="tasktable-anomaly">
                                <thead class="bg-gray-900">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Alert Name (ID)
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            KPI Name
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Dimension
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Value
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Expected Value
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Severity Score
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Timestamp
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Users
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="event-alerts" class="hidden p-4">
            <div class="flex flex-col py-4">
                <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                    <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
                        <div class="shadow overflow-hidden border-b border-gray-200 bg-gray-100 sm:rounded-2xl">
                            <table class="min-w-full divide-y divide-gray-200" id="tasktable-event">
                                <thead class="bg-gray-900">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            ID
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Alert Name
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Alert Message
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Timestamp
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Channel
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Users
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .dataTableAnomaly-table > thead > tr > th {
            vertical-align: middle;
        }
    </style>

    <style>
        .dataTableEvent-table > thead > tr > th {
            vertical-align: middle;
        }
    </style>

    <style>
    .toggle-label {
      position: relative;
    }
    .toggle-label:before {
      position: absolute;
      top: 0.125rem;
      left: 0.125rem;
      display: block;
      content: "";
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 9999%;
      background-color: white;
      background-position: center;
      background-repeat: no-repeat;
      background-size: 40%;
      background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23a0aec0" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>');
      transition: transform 0.15s cubic-bezier(0, 0, 0.2, 1);
      transform: translateX(0);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .toggle-checkbox:checked + .toggle-label:before {
      transform: translateX(1.5rem);
      background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23a0aec0" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check"><polyline points="20 6 9 17 4 12"></polyline></svg>');
    }

    .toggle.slim .toggle-label:before {
      top: -0.15rem;
      left: 0;
    }
    .toggle.slim .toggle-checkbox:checked + .toggle-label:before {
      transform: translateX(1.75rem);
    }
    .toggle.colour .toggle-label {
      background-color: #feb2b2;
    }
    .toggle.colour .toggle-checkbox:checked + .toggle-label {
      background-color: #9ae6b4;
    }
    </style>

    <script src="https://unpkg.com/simple-datatables@3.2.0/dist/umd/simple-datatables.js" type="text/javascript"></script>
    <script>
        const dataAnomaly = [
            {% for triggered_alert in anomaly_alerts_data %}
            {% for point in triggered_alert.alert_metadata["alert_data"] %}
                [ "{{ triggered_alert.alert_name }} ({{ triggered_alert.id }})",
                  "{{ triggered_alert.kpi_name }}",
                  "{{ point['Dimension'] }}",
                  "{{ point['Value'] }}",
                  "{{ point['Expected Value'] }}",
                  "{{ point['Severity Score'] }}",
                  "{{ triggered_alert.created_at }}",
                  [
                      {% for email in ["Any"] + (triggered_alert.alert_channel_conf or []) %}
                      "{{ email }}",
                      {% endfor %}
                  ],
                ],
            {% endfor %}
            {% endfor %}
        ];

        const dataTableAnomaly = new simpleDatatables.DataTable("#tasktable-anomaly", {
            data: {
                data: dataAnomaly,
            }
        });
        dataTableAnomaly.origData = dataAnomaly;
        // hide user emails columns
        dataTableAnomaly.emailColIndex = 7;
        dataTableAnomaly.columns().hide([dataTableAnomaly.emailColIndex]);

        const dataEvent = [
            {% for triggered_alert in event_alerts_data %}
            {% for point in triggered_alert.alert_metadata["alert_data"] %}
            [
                {{ triggered_alert.id }},
                {{ triggered_alert.alert_name }},
                {{ triggered_alert.created_at }},
                {{ triggered_alert.alert_channel }},
                {{ triggered_alert.alert_channel_conf }},
            ],
            {% endfor %}
            {% endfor %}
        ]
        const dataTableEvent = new simpleDatatables.DataTable("#tasktable-event", {
            data: {
                data: dataEvent,
            }
        });
        dataTableEvent.origData = dataEvent;
        dataTableEvent.emailColIndex = 4;
        dataTableEvent.columns().hide([dataTableEvent.emailColIndex]);

        const dataTables = [dataTableAnomaly, dataTableEvent];
        let currentTable = dataTables[0];
    </script>

    <script type="text/javascript">
        function downloadCSV() {
            // Variable to store the final csv data
            let csv_data = [];

            const headerRow = document.createElement("tr");
            const headers = currentTable.headings;
            for(let i = 0; i < headers.length; ++i) {
                headerRow.appendChild(headers[i].cloneNode(true));
            }

            // Get each row data
            function getRows() {
                let rows = null;
                if (currentTable.searching) {
                    const searchedRows = new Set(currentTable.searchData);
                    rows = currentTable.data.filter((_, index) => searchedRows.has(index));
                } else {
                    rows = currentTable.data;
                }

                return ([headerRow]).concat(rows);
            }

            const rows = getRows();

            for (let i = 0; i < rows.length; i++) {

                // Get each column data
                const cols = rows[i].querySelectorAll("td,th");

                // Stores each csv row data
                let csvrow = [];
                for (let j = 0; j < cols.length; j++) {
                    if (j == currentTable.emailColIndex) {
                        continue;
                    }

                    // Get the text data of each cell
                    // of a row and push it to csvrow
                    csvrow.push(cols[j].innerText.trim());
                }

                // Combine each column value with comma
                csv_data.push(csvrow.join(","));
            }

            // Combine each row data with new line character
            csv_data = csv_data.join('\n');

            // Create CSV file object and feed
            // our csv_data into it
            const CSVFile = new Blob([csv_data], {
                type: "text/csv"
            });

            // Create to temporary link to initiate
            // download process
            let temp_link = document.createElement("a");

            // Download csv file
            temp_link.download = "ChaosGenius_alert_digest_export_" + (new Date()).toISOString().slice(0, 10)
 + ".csv";
            const url = window.URL.createObjectURL(CSVFile);
            temp_link.href = url;

            // This link should not be displayed
            temp_link.style.display = "none";
            document.body.appendChild(temp_link);

            // Automatically click the link to
            // trigger download
            temp_link.click();
            document.body.removeChild(temp_link);
        }
    </script>

    <script>
        let tabsContainer = document.querySelector("#tabs");

        let tabTogglers = tabsContainer.querySelectorAll("#tabs a");

        tabTogglers.forEach(function(toggler) {
          toggler.addEventListener("click", function(e) {
            e.preventDefault();

            let tabName = this.getAttribute("href");

            let tabContents = document.getElementById("tab-contents");

            for (let i = 0; i < tabContents.children.length; i++) {
              tabTogglers[i].parentElement.classList.remove("border-t", "border-r", "border-l", "-mb-px", "bg-white");
              tabContents.children[i].classList.remove("hidden");
              if ("#" + tabContents.children[i].id === tabName) {
                currentTable = dataTables[i];
                initUserEmails(currentTable);
                continue;
              }
              tabContents.children[i].classList.add("hidden");
            }
            e.target.parentElement.classList.add("border-t", "border-r", "border-l", "-mb-px", "bg-white");
          });
        });

    </script>

    <script>
        const subdimsCheck = document.getElementById("subdims-check");

        function initSubdimsCheck() {
            let params = new URLSearchParams(location.search);

            if (params.get("subdims") == "true") {
                subdimsCheck.checked = true;
            }
        }

        initSubdimsCheck();

        subdimsCheck.addEventListener("click", () => {
            const parser = new URL(window.location);
            if (subdimsCheck.checked) {
                parser.searchParams.set("subdims", true);
            } else {
                parser.searchParams.set("subdims", false);
            }
            window.location = parser.href;
        });
    </script>

    <script type="text/javascript">
        function initUserEmails(currentTable) {
            const userEmails = new Set();

            currentTable.origData.forEach(datapoint => {
                datapoint[currentTable.emailColIndex].forEach(email => {
                    userEmails.add(email);
                })
            });

            const optionEls = Array.from(userEmails).map(email => {
                const optionEl = document.createElement("option");
                optionEl.selected = true;
                optionEl.value = email;
                optionEl.textContent = email;

                return optionEl;
            })

            const dropdown = document.getElementById("email-select");
            dropdown.replaceChildren(...optionEls);

            return userEmails;
        }

        let userEmails = initUserEmails(currentTable);

        const dropdown = document.getElementById("email-select");
        dropdown.addEventListener("input", () => {
            const selected = Array.from(dropdown.options).filter(option => option.selected).map(option => option.value);
            const selectedSet = new Set(selected);
            applyFilter(currentTable, row => {
                const intersection = row[currentTable.emailColIndex].filter(email => selectedSet.has(email));
                return intersection.length > 0;
            });
        });
    </script>

    <script type="text/javascript">
        function applyFilter(table, cb) {
            const newRows = table.origData.filter(cb);

            table.search("");

            table.rows().remove("all");
            table.rows().add(newRows);

            table.search(table.wrapper.querySelector(".dataTable-input").value);
        }
    </script>
</body>

</html>
